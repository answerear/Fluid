<center><font size="36" family="微软雅黑">基于物理的流体渲染<br>——从理论到实践</font></center>

[TOC]

# <center>数学理论</center>

## 微积分

### 导数

### 微分

### 积分

### 全导数

### 偏微分 (Partial Derivative)

### 全微分

## 向量微积分

### 梯度  (Gradient)

在向量微积分中，**梯度** (gradient) 是一种关于多元导数的概括。平常的一元（单变量）函数的导数是标量值函数，而多元函数的梯度是向量值函数。多元可微函数 $f$ 在点 $\vec{P}$ 上的梯度，是以 $f$ 在 $\vec{P}$ 上的偏导数为分量的向量。就像一元函数的导数表示这个函数图形的切线的斜率，如果多元函数在点 $\vec{P}$ 上的梯度不是零向量，则它的方向是这个函数在 $\vec{P}$ 上最大增长的方向，而它的量是在这个方向上的增长率。

梯度向量中的幅值和方向是与坐标的选择无关的独立量。

将 2D 函数 $f(x, y) = xe^{−(x^2 + y^2)}$ 的梯度绘制为蓝色箭头，还绘制了这个函数的伪色图。

![Gradient 2D](image/gradient-2d.jpg)

将函数 $f(x,y) = −(cos^2x + cos^2y)^2$ 的梯度描绘为在底面上投影的向量场。

![Gradient 3D](image/gradient-3d-cos.png)

#### 梯度的解释

假设有一个房间，房间内所有逇点的温度由一个标量场 $\phi$ 给出的，即点 (x, y, z) 的温度是 $\phi (x, y, z)$ 。假设温度不随时间变化。然后，在房间的每一点，该点的梯度将显示变热最快的方向。梯度的大小将表示在该方向上变热的速率。

考虑一座高度在 (x, y) 点的 H (x, y) 的山。H 这一点的梯度是在该点坡度（或者说斜度）最陡的方向。梯度的大小告诉我们坡度到底有多陡。

梯度也可以告诉我们一个数量在不是最快变化方向的其他方向的变化速度。再次考虑山坡的例子。可以有条直接上山的路，其坡度是最大的，则其坡度是梯度的大小。也可以有一条和上坡方向成一个角度的路，例如投影与水平面上的夹角为 60°。则，若最陡的坡度是 40%，这条路的坡度小一点，是 20%，也就是 40% 乘以 60% 的余弦。

这个现象也可以如下数学的表示。山的高度函数 H 的梯度点积一个单位向量给出表面在该向量的方向上的斜率，这成为方向导数。

#### 定义

标量函数 $f$ : $\R^n \mapsto \R$ 的梯度表示为：$\nabla{f}$ 或 grad $f$ ，其中 $\nabla$ 表示向量微分算子。

函数 $f$ 的梯度，$\nabla f$，为向量场且对任意单位向量 $\vec{v}$ 满足下列方程：
$$
(\nabla{f(x)}) \cdot \vec{v} = D_v f(x)
$$
二维直角坐标系的梯度如下：
$$
\nabla{f(x, y)} = \begin{pmatrix} \frac{\partial{f}}{\partial{x}}, \frac{\partial{f}}{\partial{y}} \end{pmatrix} = \frac{\partial{f}}{\partial{x}} \vec{i} + \frac{\partial{f}}{\partial{y}} \vec{j}
$$
三维直角坐标系的梯度如下：
$$
\nabla{f(x, y, z)} = \begin{pmatrix} \frac{\partial{f}}{\partial {x}}, \frac{\partial{f}}{\partial(y)}, \frac{\partial{f}}{\partial{z}} \end{pmatrix} = \frac{\partial{f}}{\partial{x}} \vec{i} + \frac{\partial{f}}{\partial{y}} \vec{j} + \frac{\partial{f}}{\partial{z}} \vec{k}
$$

其中 $\vec{i}$、$\vec{j}$、$\vec{k}$ 为标准的单位向量，分别指向 x, y, z 坐标的方向。

有时也会采用如下形式来表示梯度：
$$
\nabla{f} = \frac{\partial{f}}{\partial{\vec{x}}}
$$
多个函数的梯度构成了一个矩阵：
$$
\nabla{\vec{F}} = \nabla{(f, g, h)} = 
\begin{pmatrix} 
\frac{\partial{f}}{\partial{x}} & \frac{\partial{f}}{\partial{y}} & \frac{\partial{f}}{\partial{z}} \\
\frac{\partial{g}}{\partial{x}} & \frac{\partial{g}}{\partial{y}} & \frac{\partial{g}}{\partial{z}} \\
\frac{\partial{h}}{\partial{x}} & \frac{\partial{h}}{\partial{y}} & \frac{\partial{h}}{\partial{z}} \\
\end{pmatrix}
=
\begin{pmatrix}
\nabla{f} \\ \nabla{g} \\ \nabla{h}
\end{pmatrix}
$$

### 散度 (Divergence)

**散度** (Divergence) 或称发散度，是向量分析中的一个向量算子，将向量空间上的一个向量场对应到一个标量场上。散度描述的是向量场里一个点是汇聚点 (sink) 还是发源点 (source)。形象地说，就是这包含这一点的一个微小体元中的向量是“向外”居多还是“向内”居多。

举例来说，考虑空间中的静电场，其空间里的电场强度是一个向量场。正电荷附近，电场线“向外”发射，所以正电荷处的散度为正值，电荷越大，散度越大。负电荷附近，电场线“向内”，所以负电荷处的散度为负值，电荷越大，散度越小。向量值函数的散度为一个标量，而二阶张亮的散度是向量值函数。

#### 定义

定义向量场的散度，在给定一个三维空间中的向量场 **A** 以及一个简单有向曲面 $\Sigma$ ，则向量场 **A** 通过曲面 $\Sigma$ 的通量就是曲面每一点 $\vec{x}$ 上的场向量 **A($\vec{x}$)** 在曲面法方向上的分量的积分：
$$
\Phi_{\pmb{A}}(\Sigma) = \iint_\Sigma \pmb{A} \cdot \vec{n} \mathrm{d} \pmb{S}
$$
其中 $dS$ 是积分的面积元，$\vec{n}$ 是 $\Sigma$ 在点 (x, y, z) 处的单位法向量。如果曲面是封闭的，例如球面，那么通常约定法向量是从里朝外的，所以这时候的通量是描述曲面上的场向量朝外的程度。

通量描述一固定区域（也就是 $\Sigma$ ）上向量场的流通倾向，散度在某点的值则是这个性质在这点的局部描述，也就是说，从散度在一点的值，我们可以看出向量场在这点附近到底倾向发散还是收敛。要算某一点 $\vec{x}$ 的散度，先求包含这一点的某一个封闭曲面 $\Sigma$ 的通量 $\Phi_{\pmb{A}}(\Sigma)$ 除以封闭曲面 $\Sigma$ 围起来的微小体元 $\delta{\pmb{V}}$ 的体积（这个体积用 $|\delta{\pmb{V}}|$ 表示）得到的比值，向量场 **A** 在点 $\vec{x}$ 的散度即是这个比值在体积微元 $\delta{V}$ 趋向于点 $\vec{x}$ 时的极限。用数学公式表示即：
$$
div \pmb{A} = \lim_{\delta{\pmb{V}} \to {\vec{x}}} \oint_\Sigma \frac{\pmb{A} \cdot \vec{n}}{|\delta{\pmb{V}}|} \mathrm{d} \pmb{S} = \lim_{\delta{\pmb{V}} \to \vec{x}} \frac{\Phi_{\pmb{A}}(\Sigma)}{|\delta{\pmb{V}}|}
$$
如果用 $\nabla$  算子表示的话，向量场 **A** 的散度记作：$div \pmb{A} = \nabla \cdot \pmb{A}$ 

#### 物理意义

从定义中可以看到，散度是向量场的一种强度性质，就如同密度、浓度、温度一样，它对应的广延性质是一个封闭区域表面的通量，所以说散度是通量的体密度。下面从散度的极限表达式来看它的物理意义。

设 $\vec{P}$ 为场域 **V** 中的一点，现做包围 $\vec{P}$ 点的任一闭合曲面 **S** ，$\Delta{\pmb{V}}$ 是 S 面所围的区域。那么：
$$
\oint_{\pmb{S}} \pmb{A} \cdot \mathrm{d} \pmb{S} = \iiint_{\Delta{\pmb{V}}} div \pmb{A} \mathrm{d} \pmb{V}
$$
利用中值定理得
$$
\iiint_{\Delta{\pmb{V}}} div \pmb{A} \mathrm{d} \pmb{V} = (div \pmb{A})_x \cdot \left| \Delta{\pmb{V}} \right|
$$
式中 $\vec{x}$ 为 $\Delta{\pmb{V}}$ 中的某一点，$\left| \Delta{\pmb{V}} \right|$ 为 $\Delta{\pmb{V}}$ 的体积，带入上式后得
$$
\left(div \pmb{A}\right)_\vec{x} = \frac{1}{\left|\Delta{\pmb{V}}\right|} \oint_{\pmb{s}} \pmb{A} \cdot \mathrm{d} \pmb{S}
$$
令 $\Delta{\pmb{V}}$ 向点 $\vec{P}$  收缩，则 $\vec{x}$ 点就趋向于 $\vec{P}$ ，所以在 $\vec{P}$ 点的散度可由下列极限表示
$$
\left(div \pmb{A} \right)_\vec{p} = \lim_{\Delta{\pmb{V}} \to \vec{P}} \frac{1}{\left| \Delta{\pmb{V}} \right|} \oint_{\pmb{S}} \pmb{A} \cdot \mathrm{d} \pmb{S}
$$
若上式中令 $\Delta{\pmb{\Phi}} = \oint_{\pmb{S}} \pmb{A} \cdot \mathrm{d} \pmb{S}$ ，那么
$$
\left( div \pmb{A}_\vec{P} \right) = \lim_{\Delta \pmb{V} \to \vec{P}} \frac{1}{\left|\Delta{\pmb{V}} \right|} \oint_\pmb{S} \pmb{A} \cdot \mathrm{d} \pmb{S} = \lim_{\Delta{\pmb{V}} \to \vec{P}} \frac{\Delta \pmb{\Phi}}{\left| \Delta \pmb{V}\right|} = \frac{\mathrm{d} \pmb{\Phi}}{\mathrm{d} \pmb{V}}
$$
由此可见，散度是通量 $\pmb{\Phi}$ 对曲面所谓区域体积的变化率，也可看成通量在 **V** 中的分布密度。所以 div **A** 也称通量密度。

物理上，散度的意义是场的有源性。某一点或某个区域的散度大于零，表示向量场在这一点或这以区域有新的通量产生，小于零则表示向量场在这一点或区域有通量湮灭。这样的点或区域分别成为向量场的正源（发散源）和负源（洞）。举例来说，假设讲太空中各个点的热辐射强度向量看做一个向量场，那么某个热辐射源（比如太阳）周边的热辐射强度向量都指向外，说明太阳是不断产生新的热辐射的源头，其散度大于零。

散度等于零的区域称为无源场或管形场。流体力学中，散度为零的流体称为不可压缩流体，也就是说此流体中不会有一部分凭空消失或者突然产生，每个微小时间间隔中流入一个微小体元的流体总量都等于在此时间间隔内流出此体元的流体总量。

#### 散度的表示

不同的向量场的散度。向量场自点 (x,y) 的散度等于它在这个点上的 x 分量关于 x 的偏导数与 y 分量关于 y 的偏导数的和：

![散度](image/Divergence.png)
$$
\nabla \cdot (\vec{V}(x, y)) = \frac{\partial{\vec{V}_x(x, y)}}{\partial{x}} + \frac{\partial{\vec{V}_y(x, y)}}{\partial{y}}
$$
二维直角坐标系的散度如下：
$$
\nabla \cdot \vec{u} = \nabla \cdot (u, v) = \frac{\partial{u}}{\partial{x}} + \frac{\partial{v}}{\partial{y}}
$$

三维直角坐标系的散度如下：
$$
\nabla \cdot \vec{u} = \nabla \cdot (u, v, w) = \frac{\partial{u}}{\partial{x}} + \frac{\partial{v}}{\partial{y}} + \frac{\partial{w}}{\partial{z}}
$$
输入是向量，而输出为标量。类比梯度，散度符号 $\nabla \cdot \vec{u}$ 可以理解为梯度 $\nabla$ 与向量 $\vec{u}$ 的点乘：
$$
\nabla \cdot \vec{u} = 
\begin{pmatrix} 
\frac{\partial{}}{\partial{x}}, \frac{\partial{}}{\partial{y}}, \frac{\partial{}}{\partial{z}}
\end{pmatrix}
\cdot
(u, v, w)
=
\frac{\partial{}}{\partial{x}}u + \frac{\partial{}}{\partial{y}}v + 
\frac{\partial{}}{\partial{z}}w
$$

#### 高斯散度定理

既然向量场某一处的散度是向量场在该处附近通量的体密度，那么对某一个体积内的散度进行积分，就应该得到这个体积内的总通量。事实上可以证明这个推论是正确的，称为高斯散度定理。高斯定理说明，如果体积 **V** 内的向量场 **A** 拥有散度，那么散度的体积分等于向量场在 **V** 的表面 **S** 的免积分：
$$
\iiint_{\pmb{V}} div \pmb{A} \mathrm{d} v = \oiint_{\pmb{S}} \pmb{A} \cdot \vec{n}\mathrm{d} \pmb{S}
$$

### 旋度 (Curl)

### 拉普拉斯算子

## 泰勒展开

$$
f(x) = g(x) = g(x_0) + \frac{f^1(x)}{1!} (x-x_0) + \frac{f^2(x)}{2!} (x-x_0)^2 + \cdots + \frac{f^n(x)}{n!} (x-x_0)^n + \cdots
$$

$$
f(x + \Delta{x}) = f(x) + \frac{\partial{f}}{\partial{x}} \frac{\Delta{x}}{1!} + \frac{\partial^2{f}}{\partial{x}^2} \frac{\Delta{x}^2}{2!} + \cdots + \frac{\partial^n{x}}{\partial{x}^n} \frac{\Delta{x}^n}{n!} + \cdots
$$



## 线性方程

### 直接方式

### 间接方式

#### 雅克比迭代

#### 高斯-赛德尔迭代

## 插值

### Nearest Point

### Linear Interpolation

### Catmull Rom Spline Interpolation

## 流体动画

### 重力

### 压强

### 粘滞力

### 密度约束

### Navier-Stokes 方程

## 有限差分

### 向前差分

### 向后差分

### 中心差分

<div style="page-break-after:always;"></div>

# <center>基于物理的动画框架</center>

## 选择模型

## 模拟状态

## 力和移动

## 时间积分

## 约束和碰撞

<div style="page-break-after:always;"></div>

# <center>拉格朗日法  (Particle-Based Simulation)</center>

## 领域搜索

## 基于力求解 

### Smooth Particle Hydrodynamics (SPH)

## 基于位置求解

### Position Based Dynamics (PBD)

### Position Based Fluid (PBF)

<div style="page-break-after:always;"></div>

# <center>欧拉法  (Grid-Based Simulation)</center>

<div style="page-break-after:always;"></div>

# <center>拉格朗日 - 欧拉混合法</center>

<div style="page-break-after:always;"></div>